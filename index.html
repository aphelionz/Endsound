<!doctype html>
<html>
  <head>
    <title>Balls out!</title>
  </head>
  <body>
    
    <fieldset>
      <legend>Socket Shit</legend>
      
      <button id="connect">Connect</button>
      <button id="disconnect">Disconnect</button>
      
      <span>0 Users Connected</span> 
    </fieldset>
    
    <fieldset>
      <legend>Notes</legend>
      <button id="a">A</button>
      <button id="bb">Bb</button>
      <button id="b">B</button>
      <button id="c">C</button>
      <button id="cs">C#</button>
      <button id="d">D</button>
      <button id="ds">D#</button>
      <button id="e">E</button>
      <button id="f">F</button>
      <button id="fs">F#</button>
      <button id="g">G</button>
      <button id="gs">G#</button>
      
      <input type="radio" name="timbre">Square</input>
      <input type="radio" name="timbre">Triangle</input>
      <input type="radio" name="timbre">Sine</input>
      
      <input type="number" name="octave" value="0">Octave</input>
    </fieldset>
	    <input type="text" size="4" id="freq" value="440"><label for="hz">Hz</label>
	    <button onclick="start()">play</button>
	    <button onclick="stop()">stop</button>

	    <script type="text/javascript">      
	      function AudioDataDestination(sampleRate, readFn) {
	        // Initialize the audio output.
	        var audio = new Audio();
	        audio.mozSetup(1, sampleRate);

	        var currentWritePosition = 0;
	        var prebufferSize = sampleRate / 2; // buffer 500ms
	        var tail = null;

	        // The function called with regular interval to populate 
	        // the audio output buffer.
	        setInterval(function() {
	          var written;
	          // Check if some data was not written in previous attempts.
	          if(tail) {  
	            written = audio.mozWriteAudio(tail);
	            currentWritePosition += written;
	            if(written < tail.length) {
	              // Not all the data was written, saving the tail...
	              tail = tail.slice(written);
	              return; // ... and exit the function.
	            }
	            tail = null;
	          }

	          // Check if we need add some data to the audio output.
	          var currentPosition = audio.mozCurrentSampleOffset();
	          var available = currentPosition + prebufferSize - currentWritePosition;
	          if(available > 0) {
	            // Request some sound data from the callback function.
	            var soundData = new Float32Array(available);
	            readFn(soundData);

	            // Writting the data.
	            written = audio.mozWriteAudio(soundData);
	            if(written < soundData.length) {
	              // Not all the data was written, saving the tail.
	              tail = soundData.slice(written);
	            }
	            currentWritePosition += written;
	          }
	        }, 100);
	      }

	      // Control and generate the sound.

	      var frequency = 0, currentSoundSample;
	      var sampleRate = 44100;

	      function requestSoundData(soundData) {
	        if (!frequency) { 
	          return; // no sound selected
	        }
			
	        var k = 2* Math.PI * frequency / sampleRate
			for (var i=0, size=soundData.length; i<size; i++) {
	          soundData[i] = Math.sin(k * currentSoundSample++); // sine wave
				//soundData[i] = Math.sin(k * currentSoundSample++) > 0 ? 1 : -1;
	        }       
	      }

	      var audioDestination = new AudioDataDestination(sampleRate, requestSoundData);

	      function start() {
	        currentSoundSample = 0;
	        frequency = parseFloat(document.getElementById("freq").value);
	      }

	      function stop() {
	        frequency = 0;
	      }
	  </script>
    <script src="/json.js"></script> <!-- for ie -->
    <script src="/socket.io/socket.io.js"></script>
    <script> 
      var socket = new io.Socket("127.0.0.1:666"); 
      socket.connect();
      socket.on('connect', function(){ 
        console.log("connect");
      }); 
      socket.on('message', function(){
        console.log("message");
      }) 
      socket.on('disconnect', function(){
        console.log("disconnect");
      }) 
    </script>
    
  </body>
</html>